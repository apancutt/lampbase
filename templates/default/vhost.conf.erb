<VirtualHost *:<%= @params[:server_port] || node["apache"]["listen_ports"].first %>>

  ServerName <%= @params[:server_name] %>
  <% if @params[:server_aliases] -%>
  ServerAlias <%= @params[:server_aliases].join " " %>
  <% end -%>

  DocumentRoot <%= @params[:docroot] %>
  <Directory <%= @params[:docroot] %>>
    Options <%= [@params[:directory_options] || "FollowSymLinks" ].flatten.join " " %>
    AllowOverride <%= [@params[:allow_override] || "None" ].flatten.join " " %>
    <% if node["apache"]["version"] == "2.4" -%>
    Require all granted
    <% else -%>
    Order allow,deny
    Allow from all
    <% end -%>
  </Directory>

  ErrorLog <%= node["apache"]["log_dir"] %>/<%= @params[:server_name] %>-error.log
  CustomLog <%= node["apache"]["log_dir"] %>/<%= @params[:server_name] %>-access.log combined

</VirtualHost>

<% if @params[:ssl_enabled] -%>
<VirtualHost *:<%= @params[:ssl_server_port] || 443 %>>

  ServerName <%= @params[:server_name] %>
  <% if @params[:server_aliases] -%>
  ServerAlias <%= @params[:server_aliases].join " " %>
  <% end -%>

  DocumentRoot <%= @params[:docroot] %>
  <Directory <%= @params[:docroot] %>>
    Options <%= [@params[:directory_options] || "FollowSymLinks" ].flatten.join " " %>
    AllowOverride <%= [@params[:allow_override] || "None" ].flatten.join " " %>
    <% if node["apache"]["version"] == "2.4" -%>
    Require all granted
    <% else -%>
    Order allow,deny
    Allow from all
    <% end -%>
  </Directory>

  SSLEngine On
  SSLCACertificateFile <%= @params[:ssl_ca] %>
  SSLCertificateFile <%= @params[:ssl_crt] %>
  SSLCertificateKeyFile <%= @params[:ssl_key] %>

  ErrorLog <%= node["apache"]["log_dir"] %>/<%= @params[:server_name] %>-ssl-error.log
  CustomLog <%= node["apache"]["log_dir"] %>/<%= @params[:server_name] %>-ssl-access.log combined

</VirtualHost>
<% end -%>
